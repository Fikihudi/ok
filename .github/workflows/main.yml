name: Linux RDP via Playit (LXQt Optimized)

on:
  workflow_dispatch:

jobs:
  rdp-linux:
    runs-on: ubuntu-22.04

    steps:
    - name: 🧰 Install LXQt + XRDP + Tools (Clean)
      run: |
        sudo apt update
        sudo apt install -y --no-install-recommends xrdp lxqt sddm lightdm dbus-x11 x11-utils lxterminal htop curl wget

    - name: 👤 Set Session + User
      run: |
        echo "runner:password" | sudo chpasswd
        echo "startlxqt" > ~/.xsession
        sudo sed -i 's/^test -x/#&/' /etc/xrdp/startwm.sh
        echo "exec startlxqt" | sudo tee -a /etc/xrdp/startwm.sh

    - name: ⚙️ Enable & Start XRDP
      run: |
        sudo adduser xrdp ssl-cert
        sudo systemctl enable xrdp
        sudo systemctl restart xrdp

    - name: 🚀 Optimasi Kencang
      run: |
        for service in apport whoopsie bluetooth cups snapd ufw ModemManager fwupd unattended-upgrades; do
          sudo systemctl disable --now $service || true
        done
        sudo systemctl mask sleep.target suspend.target hibernate.target hybrid-sleep.target
        echo 'ulimit -n 1048576' >> ~/.bashrc
        echo 'performance' | sudo tee /sys/devices/system/cpu/cpu*/cpufreq/scaling_governor || true

    - name: 🌍 Start Playit Tunnel
      env:
        PLAYIT_AUTH_KEY: ${{ secrets.PL }}
      run: |
        curl -Lo playit https://github.com/playit-cloud/playit-agent/releases/download/v0.15.26/playit-linux-amd64
        chmod +x playit
        ./playit --secret $PLAYIT_AUTH_KEY &
        sleep 5
        echo "✅ Playit tunnel aktif, akses RDP di log/Playit panel"

    - name: 💤 Keep Alive
      run: sleep 21600
